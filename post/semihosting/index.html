<!DOCTYPE html>
<html><head>
<title>How to get rid of Semihosting</title>

<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">
<meta name="title" property="og:title" content="How to get rid of Semihosting">
<meta name="image" property="og:image" content="/images/semihosting.jpg">
<meta name="description" property="og:description" content="Most guides tell you how to set up ARM Semihosting. This is about how to get rid of it.">
<meta name="keywords" content="[arm assembly cpp]">
<meta name="author" content=""> 









<link rel="stylesheet" href="/scss/journal.min.074c04b896e4e9ec7e517f88eefd59e62ffd212b8c923ac219f7bc81825b28bd.css" integrity="sha256-B0wEuJbk6ex&#43;UX&#43;I7v1Z5i/9ISuMkjrCGfe8gYJbKL0=" media="screen">



<link rel="stylesheet" href="/scss/dark-mode.min.5d4554809a1a12cbf28366c9a81376c1681cdefc525a37617a9741c19b85f22f.css" integrity="sha256-XUVUgJoaEsvyg2bJqBN2wWgc3vxSWjdhepdBwZuF8i8=" media="screen">


<script src="/vendor/js/vue.min.js" ></script>







<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Noto+Serif+SC|Material+Icons" />







</head><body>
    	<div id="app"><div ref="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="/">
    
        <div class="nav-title">
            Asti&#39;s Notes
        </div>
        
        <div class="nav-subtitle">
            FP, Rx, EDA
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/projects">
                Projects
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/categories">
                Categories
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/tags">
                Tags
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/about">
                About
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
<br />



CC by Attribution

    </div>
    
</div><div ref="extraContainer" class="extra-container">
    
    <div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }">


	<div class="toc-content">
	
		
		
		
		<h3>Contents</h3>
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#what-is-arm-semihosting" v-on:click="closeDrawer" id="what-is-arm-semihosting-nav">
										 What is ARM Semihosting?
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#why-is-it-a-pain" v-on:click="closeDrawer" id="why-is-it-a-pain-nav">
										 Why is it a pain
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#how-to-remove-semihosting" v-on:click="closeDrawer" id="how-to-remove-semihosting-nav">
										 How to remove Semihosting
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
	</div>

</div>
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a class="pagination-action" v-on:click="toggleDarkMode">
            <i class="material-icons pagination-action-icon" v-if="isDarkMode">
                brightness_4
            </i>
            <i class="material-icons pagination-action-icon" v-else="isDarkMode">
                brightness_7
            </i>
        </a>
        
        
    </div>
</div><div class="single-column-drawer-container" ref="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/projects">
                    Projects
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/categories">
                    Categories
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/tags">
                    Tags
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/about">
                    About
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<h3>Contents</h3>
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#what-is-arm-semihosting" v-on:click="closeDrawer" id="what-is-arm-semihosting-nav">
										 What is ARM Semihosting?
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#why-is-it-a-pain" v-on:click="closeDrawer" id="why-is-it-a-pain-nav">
										 Why is it a pain
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#how-to-remove-semihosting" v-on:click="closeDrawer" id="how-to-remove-semihosting-nav">
										 How to remove Semihosting
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav ref="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div ref="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a ref="navTitle" class="navbar-brand" href="/">
            Asti&#39;s Notes
        </a>
        
        <button type="button" class="nav-darkmode-toggle" v-on:click="toggleDarkMode">
            <i class="material-icons" v-if="isDarkMode">
                brightness_4
            </i>
            <i class="material-icons" v-else="isDarkMode">
                brightness_7
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" ref="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="/">
        <div class="single-column-header-title">Asti&#39;s Notes</div>
        
        <div class="single-column-header-subtitle">FP, Rx, EDA</div>
        

    </a>
</div>
            <div id="content">
<div ref="streamContainer" class="stream-container">
    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            
                
            

            <div class="post-head-wrapper"
                 style="background-image: url('/images/semihosting.jpg')">
                <div class="post-title">
                    How to get rid of Semihosting
                    
                    <div class="post-subtitle">
                        Most guides tell you how to set up ARM Semihosting. This is about how to get rid of it.
                    </div>
                    
                    <div class="post-meta">
                        
                            <i class="material-icons" style="">folder</i>
                                <a href="/categories/embedded">/embedded</a>
                                &nbsp;
                        

                        
                            <i class="material-icons" style="">label</i>
                            
                                <a href="/tags/arm">#arm</a>
                                &nbsp;
                            
                                <a href="/tags/assembly">#assembly</a>
                                &nbsp;
                            
                                <a href="/tags/cpp">#cpp</a>
                                &nbsp;
                            
                        

                                                
                        <i class="material-icons" style="">schedule</i>
                        <time itemprop="datePublished">
                            2019-10-12
                        </time>
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                <div class="post-body">
                    <p>&hellip;<em>or</em> why my application stops when disconnected from the debugger.</p>
<p>As you can tell from the image, I've been bitten badly by semihosting before.</p>
<h2 id="what-is-arm-semihosting">What is ARM Semihosting?</h2>
<p>Semihosting is a mechanism that enables code running on an ARM target to communicate and use the Input/Output facilities on a host computer running a debugger.</p>
<p>To put it simply, it lets you use <code>printf</code>, <code>scanf</code> and other syscalls on a target where the host acts as the &lsquo;system&rsquo; in those calls. ARM Semihosting can be useful when other avenues of troubleshooting are difficult.</p>
<h2 id="why-is-it-a-pain">Why is it a pain</h2>
<p>The culprit:</p>
<pre><code class="language-assembly" data-lang="assembly">BKPT 0xAB
</code></pre><p>ARM processors use the <code>BKPT</code>instruction on the Cortex M0, M0+, M1, M3, M4. M7 and on others the <code>SVC</code> instruction (previously <code>SWI</code>). Now the implementation of <code>BKPT</code> is - when the instruction is encountered, the CPU halts and waits for the host to respond.</p>
<p>When the host does not support semihosting, or there is no debugger connected - that's the end of the line.</p>
<h2 id="how-to-remove-semihosting">How to remove Semihosting</h2>
<p>You may not be intentionally using Semihosting, but your toolchain might be building with Semihosting. Here's what to look for:</p>
<ul>
<li>
<p>Linker flags should be <code>--specs=nosys.specs</code> and not <code>–specs=rdimon.specs</code></p>
<p>nosys = no POSIX calls, so if your build fails you've got some work left. If you were already building with <code>nosys</code>, and this doesn't help, read on.</p>
</li>
<li>
<p>Compile this (not for ARM, for x86!), and replace <code>g++</code> or <code>ld</code> with it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;iostream&gt; </span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#66d9ef">using</span> <span style="color:#66d9ef">namespace</span> std; 

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span><span style="color:#f92672">*</span> argv) 
{ 
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> argc; <span style="color:#f92672">+</span><span style="color:#f92672">+</span>i) 
        cout <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> argv[i] <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74"> </span><span style="color:#e6db74">&#34;</span>; 

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>; 
} 
</code></pre></div><p>Your build script may be responsible.
Replacing the compiler with this dummy executable which just prints out the input arguments is helpful in troubleshooting it.
Make sure that at no point is <code>rdimon.specs</code> ever mentioned</p>
</li>
<li>
<p>Check your source for a call to <code>initialise_monitor_handles</code> (check your startup files as well) - this is specifically for trigering <a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.faqs/ka8256.html">RDI</a></p>
</li>
<li>
<p>Implement dummy versions of</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">_write</span>(<span style="color:#66d9ef">int</span> file, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>ptr, <span style="color:#66d9ef">int</span> len);
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">_write_r</span>(<span style="color:#66d9ef">struct</span> _reent <span style="color:#f92672">*</span>r, <span style="color:#66d9ef">int</span> file, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>ptr, size_t len);
</code></pre></div></li>
<li>
<p>Check stacktraces for any call using <code>printf</code> with semihosting disabled (this should trigger a trap)</p>
</li>
<li>
<p>If using VisualGDB, install the Advanced Semihosting and Profiler framework and select &lsquo;ignore semihosting calls&rsquo;</p>
</li>
<li>
<p>Check dissasembly of syscalls (<code>_write, _system, _start...</code>)</p>
<p><figure>
    <img src="/images/disas1.jpg"/> 
</figure>

<figure>
    <img src="/images/disas2.jpg"/> 
</figure>
</p>
<p>Track down the sources of the syscalls. Try replacing <em>libc</em> or <em>newlib</em> with another copy.</p>
</li>
<li>
<p>Trust nothing. Not even the the <a href="https://en.wikipedia.org/wiki/Crt0">C runtime</a>. Versions of <code>crt0.s</code> with <code>BKPT</code> in them have been shipped.</p>
<p>Replace <code>cortex_m*/crt0.o</code> in your toolchain with one from another version of the toolchain or from another vendor's. It shouldn't matter.</p>
</li>
<li>
<p>Disassemble and repeat until you find the call responsible</p>
</li>
<li>
<p>If all else fails, toss everything in the fire and start over</p>
</li>
</ul>

                    
                    <HR width="100%" id="EOF">
                    <p style="color:#777;">Last modified on 2019-10-12</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts" href="/post/boost-beware/">
                    Next<br>Boost beware
                </a>
                
                
                
                <a class="older-posts" href="/post/git-config-parser/">
                    Previous<br>A git-config parser
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                
                <p style="opacity: 0.6" align="center">
                    <small>Comments Disabled.</small>
                </p>
                
            </div>
        </div>
    </div>
</div>

            </div><div id="single-column-footer">
<br />



CC by Attribution
</div>
            </div>    
            <script src="/js/journal.js"></script>
    </body>
</html>
